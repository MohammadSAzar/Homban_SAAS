{% extends '_base_dashboard.html' %}

{% load static %}
{% load i18n %}
{% load jalali_tags %}
{% load number_converter %}
{% load widget_tweaks %}
{% load humanize %}
{% load pagination %}


{% block title %}یادآورها{% endblock %}


{% block content %}

    <!-- Message -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <h4 class="modal-title" style="padding: 20px 20px 10px 0;!important;">تغییرات در سامانه ثبت شد.</h4>
            <button class="modal-my-button">بستن پیام</button>
        </div>
    </div>
    <script>
        $(document).ready(function() {
            var messages = "{% for message in messages %}{{ message }}{% if not forloop.last %}\\n{% endif %}{% endfor %}";
            if (messages) {
                $('#modal-message').text(messages);
                $('#successModal').show();
            }
            $('.modal-my-button').on('click', function() {
                $('#successModal').hide();
            });
        });
    </script>
    
    <!-- Main -->
    <div class="nk-block">

        <!-- Title -->
        <div class="nk-block-head  nk-block-head-sm" style="margin-bottom: 1.2em;">
            <div class="nk-block-between position-relative">
                <div class="nk-block-head-content">
                    <h5 class="nk-block-title page-title">یادآورها</h5>
                </div>
            </div>
        </div>
        <!-- end: Title -->

        <!-- List -->
        <div class="row g-gs">
            <div class="col-lg-12">
                <div class="row g-gs">
                    <!-- Loop -->
                    {% for reminder in reminders %}
                        <div class="col-sm-6 col-lg-6 col-xxl-6">
                            <div class="card h-100">
                                <div class="card-inner">
                                    <div class="project">

                                        <!-- Up -->
                                        <div class="project-head">
                                            <div class="project-title">
                                                <div class="project-info">
                                                    <h6 class="title">{{ reminder.title }} | {{ reminder.code }}</h6>
                                                    <span class="sub-text" style="font-size: 0.95em; margin-top: 0.7em;">{{ reminder.agent.name_family|default:reminder.agent }} | {{ reminder.agent.sub_district }}</span>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Description -->
                                        <div class="project-details">
                                            <p style="height: 8em; overflow: hidden; margin-bottom: 0.5em;">
                                                {{ reminder.description|truncatewords:20|farsi_number }}
                                                <button class="btn btn-sm btn-outline-primary show-full-description"
                                                        data-reminder-id="{{ reminder.pk }}"
                                                        style="font-size: 0.8em;">
                                                    نمایش کامل
                                                </button>
                                            </p>
                                        </div>
                                        <!-- Modal -->
                                        <div id="descriptionModal-{{ reminder.pk }}" class="modal" style="margin-top: 5em; display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7);">
                                            <div class="modal-content" style="background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 700px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                                                <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px;">
                                                    <h5 style="margin: 0; color: #333;">توضیحات کامل</h5>
                                                    <span onclick="closeModal('{{ reminder.pk }}')" style="font-size: 28px; font-weight: bold; cursor: pointer; color: #aaa;">&times;</span>
                                                </div>
                                                <div style="line-height: 1.6; padding: 10px 0;">
                                                    {{ reminder.description|farsi_number|linebreaksbr }}
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Middle1 -->
                                        <div style="height: 8em;!important; -webkit-line-clamp: 4;!important;">
                                            <h6 class="title" style="margin-bottom: 0.7em;">مشتری (خریدار/موجر) مربوطه:</h6>
                                            <!-- Buyer -->
                                            {% if reminder.buyer %}
                                                <div class="project-head" style="margin-bottom: 0.5em;!important;">
                                                    <div class="project-title">
                                                        <div class="project-info">
                                                            <a href="{{ reminder.buyer.get_absolute_url }}">
                                                                <span class="sub-text" style="font-size: 0.85em;">خریدار: {{ reminder.buyer.name }}</span>
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% else %}
                                                <div class="project-head" style="margin-bottom: 0.5em;!important;">
                                                    <div class="project-title">
                                                        <div class="project-info">
                                                            <span class="sub-text" style="font-size: 0.85em;">خریدار: ----</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endif %}

                                            <!-- Renter -->
                                            {% if reminder.renter %}
                                                <div class="project-head" style="margin-bottom: 0.5em;!important;">
                                                    <div class="project-title">
                                                        <div class="project-info">
                                                            <a href="{{ reminder.renter.get_absolute_url }}">
                                                                <span class="sub-text" style="font-size: 0.85em;">موجر: {{ reminder.renter.name }}</span>
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% else %}
                                                <div class="project-head" style="margin-bottom: 0.5em;!important;">
                                                    <div class="project-title">
                                                        <div class="project-info">
                                                            <span class="sub-text" style="font-size: 0.85em;">موجر: ----</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endif %}
                                        </div>

                                        <!-- Middle2 -->
                                        <div style="height: 8em;!important; -webkit-line-clamp: 4;!important;">
                                            <h6 class="title" style="margin-bottom: 0.7em;">فایل (فروش/اجازه) مربوطه:</h6>
                                            <!-- SaleFile -->
                                            {% if reminder.sale_file %}
                                                <div class="project-head" style="margin-bottom: 0.5em;!important;">
                                                    <div class="project-title">
                                                        <div class="project-info">
                                                            <a href="{{ reminder.sale_file.get_absolute_url }}">
                                                                <span class="sub-text" style="font-size: 0.85em;">فایل اجاره: {{ reminder.sale_file.title }}</span>
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% else %}
                                                <div class="project-head" style="margin-bottom: 0.5em;!important;">
                                                    <div class="project-title">
                                                        <div class="project-info">
                                                            <span class="sub-text" style="font-size: 0.85em;">فایل فروش: ----</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endif %}

                                            <!-- RentFile -->
                                            {% if reminder.rent_file %}
                                                <div class="project-head" style="margin-bottom: 0.5em;!important;">
                                                    <div class="project-title">
                                                        <div class="project-info">
                                                            <a href="{{ reminder.rent_file.get_absolute_url }}">
                                                                <span class="sub-text" style="font-size: 0.85em;">فایل فروش: {{ reminder.rent_file.title }}</span>
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% else %}
                                                <div class="project-head" style="margin-bottom: 0.5em;!important;">
                                                    <div class="project-title">
                                                        <div class="project-info">
                                                            <span class="sub-text" style="font-size: 0.85em;">فایل اجاره: ----</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endif %}
                                        </div>

                                        <!-- Bottom -->
                                        <div class="project-head">
                                            <div class="project-title">
                                                <div class="project-info">
                                                    <span class="sub-text" style="font-size: 0.95em; margin-top: 0.7em;">تاریخ: {{ reminder.date }}</span>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Delete -->
                                        <div class="project-meta">
{#                                            <a href="{% url 'reminder_update' reminder.pk reminder.code %}" class="btn btn-primary justify-center" style="margin-top: 1em;"><em class="icon ni ni-edit"></em><span>ویرایش</span></a>#}
                                            <a href="{% url 'reminder_delete' reminder.pk reminder.code %}" class="btn btn-danger justify-center" style="margin-top: 1em;"><em class="icon ni ni-delete"></em><span>حذف</span></a>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                    <!-- end: Loop -->
                </div>
            </div>
        </div>
        <!-- end: List-->

        <!-- JS -->
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // Event delegation for all "show full description" buttons
                document.addEventListener('click', function(e) {
                    if (e.target.classList.contains('show-full-description')) {
                        const reminderId = e.target.getAttribute('data-reminder-id');
                        const modal = document.getElementById('descriptionModal-' + reminderId);
                        if (modal) {
                            modal.style.display = 'block';
                            document.body.style.overflow = 'hidden';
                        }
                    }

                    // Close modal when clicking on X or outside
                    if (e.target.classList.contains('close-modal') || e.target.classList.contains('modal')) {
                        const modal = e.target.closest('.modal') || e.target;
                        if (modal) {
                            modal.style.display = 'none';
                            document.body.style.overflow = 'auto';
                        }
                    }
                });

                // Alternative close function for buttons with onclick
                window.closeModal = function(reminderId) {
                    const modal = document.getElementById('descriptionModal-' + reminderId);
                    if (modal) {
                        modal.style.display = 'none';
                        document.body.style.overflow = 'auto';
                    }
                };
            });
        </script>

        <!-- CSS -->
        <style>
            .modal {
                display: none;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                overflow: auto;
                background-color: rgba(0,0,0,0.7);
            }

            .modal-content {
                background-color: #fefefe;
                margin: 5% auto;
                padding: 20px;
                border: 1px solid #888;
                width: 80%;
                max-width: 700px;
                border-radius: 8px;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                animation: modalopen 0.3s;
            }

            .close-modal {
                font-size: 28px;
                font-weight: bold;
                cursor: pointer;
                color: #aaa;
            }

            .close-modal:hover {
                color: #000;
            }

            @keyframes modalopen {
                from { opacity: 0; transform: translateY(-30px); }
                to { opacity: 1; transform: translateY(0); }
            }

            @media (max-width: 768px) {
                .modal-content {
                    width: 90%;
                    margin: 20% auto;
                }
            }
        </style>


    </div>
    <!-- end: Main -->
    
    <!-- Pagination -->
    {% pagination page_obj request 'reminder_list' %}
    <!-- end: Pagination -->

{% endblock %}


